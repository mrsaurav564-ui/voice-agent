# Quiz Website Backend Implementation Plan

Implementing a fully functional PostgreSQL and Node.js backend for the quiz website with support for multiple quiz round types (General, Buzzer, Rapid Fire, Visual, Audio rounds) to replace the current mock data and localStorage-based implementation.

## User Review Required

> [!IMPORTANT]
> **Breaking Changes**: This implementation will transition from localStorage-based authentication to JWT token-based authentication. Users will need to re-register after deployment.

> [!IMPORTANT]
> **PostgreSQL Required**: You need to have PostgreSQL installed and running on your machine. If you don't have it installed, please let me know and I'll provide installation instructions.

> [!WARNING]
> **Environment Variables**: Sensitive credentials (database password, JWT secret, Google OAuth) will be stored in a `.env` file. This file must NOT be committed to version control.

## Proposed Changes

### Backend Server (Node.js/Express)

#### [NEW] [package.json](file:///d:/quiz/package.json)
- Initialize Node.js project with dependencies: `express`, `pg` (PostgreSQL client), `bcryptjs` (password hashing), `jsonwebtoken` (JWT auth), `cors`, `dotenv`, `express-validator`
- Dev dependencies: `nodemon` for auto-restart during development

---

#### [NEW] [server.js](file:///d:/quiz/server.js)
- Main Express server setup
- Database connection initialization
- Route registration for all API endpoints
- Error handling middleware
- CORS configuration for frontend-backend communication
- Server listening on port 3000

---

#### [NEW] [.env.example](file:///d:/quiz/.env.example)
- Template for environment variables
- Database connection details (host, port, database name, user, password)
- JWT secret key
- Google OAuth credentials
- Server port configuration

---

### Database Layer

#### [NEW] [database/schema.sql](file:///d:/quiz/database/schema.sql)
- Complete PostgreSQL database schema with round type support
- **users** table: id, email, password_hash, name, avatar_url, created_at, last_login
- **quizzes** table: id, title, category, difficulty, description, questions_count, round_type (general/buzzer/rapid/visual/audio), round_config (JSON), created_at
- **questions** table: id, quiz_id, question_text, options (JSON), correct_answer, points, media_url, media_type, time_limit
- **quiz_rounds** table: id, quiz_id, round_number, round_type, config (JSON for round-specific settings)
- **user_scores** table: id, user_id, quiz_id, score, time_taken, round_data (JSON), completed_at
- **multiplayer_sessions** table: id, quiz_id, session_code, host_user_id, status, created_at
- **session_participants** table: session_id, user_id, buzzer_locked, buzz_time, score, joined_at
- **achievements** table: id, name, description, icon, unlock_criteria (JSON)
- **user_achievements** table: user_id, achievement_id, unlocked_at
- **leaderboard view**: Aggregated user statistics for rankings
- **user_stats view**: Individual user statistics (games played, wins, streaks)
- Indexes for performance optimization

---

#### [NEW] [database/seed.sql](file:///d:/quiz/database/seed.sql)
- Sample quiz data (Science, History, Geography, Sports, Entertainment)
- Sample questions for each quiz
- Default achievements
- Demo user accounts (for testing)

---

#### [NEW] [database/db.js](file:///d:/quiz/database/db.js)
- PostgreSQL connection pool configuration
- Database query wrapper functions
- Error handling for database operations
- Connection validation and retry logic

---

### API Routes

#### [NEW] [routes/auth.js](file:///d:/quiz/routes/auth.js)
- **POST /api/auth/register**: User registration with email validation and password hashing
- **POST /api/auth/login**: User login with JWT token generation
- **POST /api/auth/google**: Google OAuth authentication
- **POST /api/auth/logout**: Logout (token invalidation)
- **GET /api/auth/verify**: Verify JWT token validity

---

#### [NEW] [routes/users.js](file:///d:/quiz/routes/users.js)
- **GET /api/users/profile**: Get current user profile
- **PUT /api/users/profile**: Update user profile (name, avatar)
- **GET /api/users/stats**: Get user statistics (games, wins, streaks, achievements)
- **GET /api/users/:id**: Get public profile of another user

---

#### [NEW] [routes/quizzes.js](file:///d:/quiz/routes/quizzes.js)
- **GET /api/quizzes**: Get all quizzes with optional filtering (category, difficulty, round_type)
- **GET /api/quizzes/:id**: Get specific quiz details including round configuration
- **GET /api/quizzes/:id/questions**: Get questions for a quiz with media URLs
- **POST /api/quizzes/:id/submit**: Submit quiz answers and calculate score (round-specific scoring)
- **GET /api/quizzes/featured**: Get featured/recommended quizzes
- **POST /api/quizzes/:id/start**: Start a quiz session (initialize timers for rapid rounds)
- **POST /api/quizzes/:id/answer**: Submit single answer (for rapid fire rounds)

---

#### [NEW] [routes/leaderboard.js](file:///d:/quiz/routes/leaderboard.js)
- **GET /api/leaderboard/global**: Global leaderboard (all time)
- **GET /api/leaderboard/weekly**: Weekly leaderboard
- **GET /api/leaderboard/monthly**: Monthly leaderboard
- **GET /api/leaderboard/friends**: Friends leaderboard (requires friends feature)
- **GET /api/leaderboard/rank/:userId**: Get specific user's rank

---

#### [NEW] [routes/achievements.js](file:///d:/quiz/routes/achievements.js)
- **GET /api/achievements**: Get all achievements with unlock status
- **GET /api/achievements/unlocked**: Get user's unlocked achievements
- **POST /api/achievements/check**: Check and unlock achievements based on user activity

---

### Middleware

#### [NEW] [middleware/auth.js](file:///d:/quiz/middleware/auth.js)
- JWT token verification middleware
- Extract user ID from token and attach to request
- Handle authentication errors (invalid/expired tokens)

---

#### [NEW] [middleware/validation.js](file:///d:/quiz/middleware/validation.js)
- Input validation middleware using express-validator
- Email format validation
- Password strength validation
- Request body sanitization

---

### Frontend Integration

#### [MODIFY] [script.js](file:///d:/quiz/script.js)
- Update API endpoint from `/api/login` to `http://localhost:3000/api/auth/login`
- Store JWT token in localStorage on successful login
- Include JWT token in Authorization header for authenticated requests
- Handle token refresh logic
- Update Google OAuth to send credential to backend

---

#### [MODIFY] [dashboard.js](file:///d:/quiz/dashboard.js)
- Replace hardcoded sample data with API calls
- **Fetch user profile**: GET /api/users/profile
- **Fetch user stats**: GET /api/users/stats
- **Fetch quizzes**: GET /api/quizzes
- **Fetch leaderboard**: GET /api/leaderboard/global
- **Fetch achievements**: GET /api/achievements
- Include Authorization header with JWT token in all API requests
- Handle API errors and redirect to login on 401 Unauthorized

---

#### [MODIFY] [config.js](file:///d:/quiz/config.js)
- Add API base URL configuration
- Update to support environment-based URLs (development vs production)

---

#### [NEW] [signup.html](file:///d:/quiz/signup.html)
- User registration form (email, password, confirm password, name)
- Client-side validation
- Link to registration API endpoint
- Redirect to login on successful registration

---

## Verification Plan

### Automated Tests

**Database Schema Verification**
```bash
# Navigate to d:/quiz
cd d:/quiz

# Run PostgreSQL schema creation
psql -U postgres -d quiz_db -f database/schema.sql

# Verify tables were created
psql -U postgres -d quiz_db -c "\dt"
```

**Backend Server Start**
```bash
# Install dependencies
npm install

# Start server in development mode
npm run dev

# Server should start on http://localhost:3000
# Expected output: "Server running on port 3000" and "Database connected successfully"
```

**API Endpoint Testing** (using curl or Postman)
```bash
# Test registration
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"test@example.com\",\"password\":\"Test1234\",\"name\":\"Test User\"}"

# Expected: 201 Created with user object and JWT token

# Test login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"test@example.com\",\"password\":\"Test1234\"}"

# Expected: 200 OK with JWT token

# Test get quizzes
curl -X GET http://localhost:3000/api/quizzes

# Expected: 200 OK with array of quiz objects
```

### Manual Verification

1. **User Registration Flow**
   - Open browser to `http://localhost:5500/signup.html` (or your local server)
   - Fill in registration form with valid email and password
   - Click "Sign Up" button
   - Verify: Should redirect to login page with success message
   - Check database: Verify user was created in `users` table

2. **User Login Flow**
   - Open browser to `http://localhost:5500/index.html`
   - Enter registered email and password
   - Click "Sign In" button
   - Verify: Should see success animation and redirect to dashboard
   - Check localStorage: Verify JWT token is stored
   - Check dashboard: Verify user name and avatar are displayed correctly

3. **Dashboard Data Loading**
   - After login, verify all sections load data from backend:
     - Home: Stats should show real data (games played, total score, etc.)
     - Play Quiz: Quizzes should be fetched from database
     - My Scores: Should show actual score history
     - Leaderboard: Should display rankings from database
     - Achievements: Should show achievements with unlock status
     - Profile: Should display user information from database

4. **Quiz Gameplay**
   - Click on a quiz from the "Play Quiz" section
   - Verify: Questions are loaded from backend
   - Answer all questions
   - Submit quiz
   - Verify: Score is calculated and saved to database
   - Check "My Scores": New score should appear
   - Check leaderboard: Rankings should update if score is high enough

5. **Google OAuth**
   - Click "Sign in with Google" button
   - Complete Google authentication
   - Verify: User is created in database with Google ID
   - Verify: JWT token is issued and stored
   - Verify: Redirected to dashboard with user profile populated

6. **Error Handling**
   - Try logging in with wrong password → Should show error message
   - Try accessing dashboard without login → Should redirect to login page
   - Try submitting invalid data → Should show validation errors
   - Stop backend server → Frontend should show connection error

> [!NOTE]
> If you need help running PostgreSQL or setting up the database, please let me know. I can provide step-by-step instructions for Windows/macOS/Linux.

> [!TIP]
> For testing, I'll create a demo user account with pre-populated data so you can immediately see the dashboard in action after logging in.
